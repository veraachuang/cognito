(()=>{async function e(){const e=await fetch("http://localhost:3001/api/secret"),t=await e.json();return console.log("Secret key:",t.key),t.key}document.getElementById("add-docs-button")?.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept=".pdf,.doc,.docx",e.multiple=!0,e.onchange=e=>{const t=e.target.files;console.log("Files selected:",t)},e.click()}));let t=null;console.log("[Cognito] Sidebar script loaded"),window.parent.postMessage({action:"sidebarReady"},"*"),window.addEventListener("message",(e=>{"docId"===e.data?.action&&(t=e.data.value,console.log("[Cognito] Received Doc ID →",t))})),document.addEventListener("DOMContentLoaded",(()=>{const n=document.getElementById("close-sidebar"),a=document.querySelectorAll(".tab-button"),s=document.querySelectorAll(".tab-panel"),l=document.getElementById("braindump-input"),c=document.getElementById("analyzing-spinner"),d=document.getElementById("file-input"),m=document.getElementById("upload-button"),u=document.getElementById("upload-dropzone"),g=document.getElementById("uploaded-files"),p=document.getElementById("analyze-button"),y=(document.getElementById("outline-container"),document.getElementById("regenerate-outline")),h=document.getElementById("apply-outline");function f(e){a.forEach((t=>t.classList.toggle("active",t.dataset.tab===e))),s.forEach((t=>t.classList.toggle("active",t.id===e))),"braindump"===e&&o(l.value)}function E(e){if(g)for(const n of e){const e=document.createElement("div");e.className="file-item";let o="fa-file";const a=n.name.split(".").pop().toLowerCase();"pdf"===a?o="fa-file-pdf":"doc"===a||"docx"===a?o="fa-file-word":"txt"===a&&(o="fa-file-lines"),e.innerHTML=`\n          <i class="fas ${o}" style="margin-right: 10px; color: var(--primary-text);"></i>\n          <span>${n.name}</span>\n          <span style="margin-left: auto; font-size: 12px; color: #666;">${t=n.size,t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}</span>\n          <button class="icon-button remove-file" style="margin-left: 8px;">\n            <i class="fas fa-times"></i>\n          </button>\n        `;const i=e.querySelector(".remove-file");i&&i.addEventListener("click",(()=>{e.remove()})),g.appendChild(e)}var t}f("braindump"),n.addEventListener("click",(()=>{window.parent.postMessage({action:"closeSidebar"},"*")})),a.forEach((e=>{e.addEventListener("click",(()=>f(e.dataset.tab)))})),p&&p.addEventListener("click",(async()=>{const e=l.value.trim();if(e){p.disabled=!0,p.innerHTML='<i class="fas fa-spinner fa-spin"></i> Generating...';try{r(await i(e)),f("outline")}catch(e){console.error("Error generating outline:",e),alert("Failed to generate outline. Please try again.")}finally{p.disabled=!1,p.innerHTML="Analyze & Create Outline"}}else alert("Please enter some text in the brain dump area first.")})),y&&y.addEventListener("click",(async()=>{const e=l.value.trim();if(e){y.disabled=!0,y.innerHTML='<i class="fas fa-spinner fa-spin"></i> Regenerating...';try{r(await i(e))}catch(e){console.error("Error regenerating outline:",e)}finally{y.disabled=!1,y.innerHTML='<i class="fas fa-redo"></i> Regenerate'}}})),h&&h.addEventListener("click",(()=>{if(!t)return alert("Error: No document ID found. Please try reloading the page."),void console.error("[Cognito] Missing document ID when trying to apply outline");h.disabled=!0,h.innerHTML='<i class="fas fa-spinner fa-spin"></i> Applying...';try{const e=document.getElementById("outline-container");if(!e)throw new Error("Outline container not found");let n=function(e){const t=e.querySelectorAll("li");let n="";return t.forEach((t=>{let o=0,a=t.parentElement;for(;a&&a!==e;)"UL"===a.tagName&&o++,a=a.parentElement;const i="  ".repeat(Math.max(0,o-1));let r="";const s=t.querySelector(".outline-marker"),l=t.querySelector(".section-title");l?(r=l.textContent.trim(),n&&(n+="\n"),n+=`${r}\n`):(r=s?`${s.textContent} ${t.textContent.replace(s.textContent,"").trim()}`:t.textContent.trim(),n+=`${i}${r}\n`)})),n}(e);if(!n.trim())throw new Error("No outline content found. Please generate an outline first.");n="OUTLINE\n\n"+n,console.log("[Cognito] Extracted outline length:",n.length),console.log("[Cognito] Preview:",n.substring(0,100)+"..."),window.parent.postMessage({action:"applyOutline",outline:n,docId:t},"*"),console.log("[Cognito] Simple text outline sent to parent window")}catch(e){console.error("[Cognito] Error preparing outline:",e),alert(`Error: ${e.message||"Unknown error preparing outline"}`)}finally{setTimeout((()=>{h.disabled=!1,h.innerHTML='<i class="fas fa-file-alt"></i> Apply to Document'}),2e3)}})),m&&d&&m.addEventListener("click",(()=>{d.click()})),d&&d.addEventListener("change",(e=>{E(e.target.files)})),u&&(u.addEventListener("dragover",(e=>{e.preventDefault(),u.classList.add("drag-over")})),u.addEventListener("dragleave",(()=>{u.classList.remove("drag-over")})),u.addEventListener("drop",(e=>{e.preventDefault(),u.classList.remove("drag-over"),e.dataTransfer.files.length>0&&E(e.dataTransfer.files)}))),l.addEventListener("input",(e=>{o(e.target.value),localStorage.setItem("lastWritingUpdate",Date.now())}));const v=document.getElementById("analyze-doc-button"),w=document.getElementById("analysis-status"),I=document.getElementById("recommendations-container");v&&v.addEventListener("click",(async()=>{w.textContent="Fetching document text...",I.innerHTML="",c&&(c.style.display="block");try{const n=await async function(){if(!t)throw new Error("No Google-Docs ID – the iframe never received it.");return new Promise(((e,n)=>{chrome.runtime.sendMessage({action:"getDocText",docId:t},(t=>chrome.runtime.lastError?n(chrome.runtime.lastError.message):t?t.error?n(t.error):t.text?void e(t.text):n("Background returned no text."):n("No response from background.")))}))}();w.textContent="Analyzing...",await async function(t){const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await e()}`},body:JSON.stringify({model:"gpt-4",messages:[{role:"system",content:"Return JSON with keys: vocabulary_level, sentence_structure, clarity_score, engagement_score, recommendations."},{role:"user",content:`Analyze the following for grade level, clarity, vocabulary, engagement:\n\n${t}`}]})}),o=(await n.json()).choices?.[0]?.message?.content||"{}";let a;try{a=JSON.parse(o)}catch(e){throw new Error(o)}document.getElementById("vocabulary-level").textContent=a.vocabulary_level||"-",document.getElementById("sentence-structure").textContent=a.sentence_structure||"-";const i=e=>"number"==typeof e&&e<=1?Math.round(100*e)+"%":e;document.getElementById("clarity-score").textContent=i(a.clarity_score),document.getElementById("engagement-score").textContent=i(a.engagement_score);let r=[];Array.isArray(a.recommendations)?r=a.recommendations:"string"==typeof a.recommendations&&(r=[a.recommendations]),r.length?document.getElementById("recommendations-container").innerHTML=`<ul>${r.map((e=>`<li>${e}</li>`)).join("")}</ul>`:document.getElementById("recommendations-container").innerHTML='<p class="suggested-length">No recommendations returned.</p>'}(n),w.textContent="Analysis complete."}catch(e){w.textContent="Failed to analyze.",I.innerHTML=`<p class="error">Error: ${e}</p>`}finally{c&&(c.style.display="none")}}))}));let n="";function o(e){const t=e.trim().split(/\s+/).length;if(document.getElementById("word-count").textContent=t||0,t<5)return document.getElementById("reading-time").textContent="< 1 min",document.getElementById("grade-level").textContent="-",void(document.getElementById("writing-style").textContent="-");e!==n&&(function(e){const t=e.trim().split(/\s+/).slice(-10),n=new Set(t),o=localStorage.getItem("lastWritingUpdate");return n.size<5||o&&Date.now()-o>3e4}(e)&&function(){const e=document.getElementById("prompts-container");e.innerHTML="",["What is the main point you want to convey?","How does this connect to your previous ideas?","Can you provide an example to illustrate this?","What would someone who disagrees with you say?","How does this relate to your overall topic?"].forEach((t=>{const n=document.createElement("div");n.className="prompt",n.textContent=t,n.onclick=()=>{const e=document.getElementById("braindump-input");e&&(e.value+=`\n\n${t}`,e.focus())},e.appendChild(n)}))}(),a(e))}const a=function(e){let t;return function(...n){const o=this;clearTimeout(t),t=setTimeout((()=>e.apply(o,n)),1e3)}}((async t=>{try{document.getElementById("reading-time").textContent="...",document.getElementById("grade-level").textContent="...",document.getElementById("writing-style").textContent="...";const o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await e()}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:'You are an expert writing analyzer. Return a JSON object with the following keys: reading_time_minutes (number), grade_level (number), writing_style (string: "Academic", "Conversational", or "Balanced"). Be concise and return only valid JSON.'},{role:"user",content:`Analyze this text for reading time, grade level, and style. Keep it quick and simple:\n\n${t.substring(0,1e3)}${t.length>1e3?"...":""}`}]})}),a=await o.json(),i=a.choices?.[0]?.message?.content;if(!i)throw new Error("Invalid API response");let r;try{r=JSON.parse(i)}catch(e){const t=i.match(/reading_time_minutes"?\s*:\s*(\d+)/),n=i.match(/grade_level"?\s*:\s*(\d+)/),o=i.match(/writing_style"?\s*:\s*"([^"]+)"/);r={reading_time_minutes:t?parseInt(t[1]):1,grade_level:n?parseInt(n[1]):8,writing_style:o?o[1]:"Balanced"}}document.getElementById("reading-time").textContent=`${r.reading_time_minutes||1} min`,document.getElementById("grade-level").textContent=r.grade_level||"-",document.getElementById("writing-style").textContent=r.writing_style||"Balanced",n=t}catch(e){console.error("Error analyzing text with AI:",e);const n=t.trim().split(/\s+/).length,o=Math.ceil(n/200),a=function(e){const t=e.trim().split(/\s+/),n=e.split(/[.!?]+/).filter((e=>e.trim())),o=function(e){return e.trim().toLowerCase().split(/\s+/).reduce(((e,t)=>(t=t.replace(/[^a-z]/g,"")).length<=3?e+1:e+t.replace(/[^aeiouy]+/g," ").trim().split(/\s+/).length),0)}(e),a=t.length/Math.max(1,n.length),i=o/Math.max(1,t.length);return Math.round(.39*a+11.8*i-15.59)}(t),i=function(e){const t=e.trim().split(/\s+/),n=e.split(/[.!?]+/).filter((e=>e.trim())),o=t.reduce(((e,t)=>e+t.length),0)/Math.max(1,t.length),a=t.length/Math.max(1,n.length);return o>5&&a>20?"Academic":o<4&&a<15?"Conversational":"Balanced"}(t);document.getElementById("reading-time").textContent=`${o} min`,document.getElementById("grade-level").textContent=a,document.getElementById("writing-style").textContent=i}}));async function i(t){const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await e()}`},body:JSON.stringify({model:"gpt-4",messages:[{role:"system",content:'You are an expert at creating essay outlines from rough ideas. Your role is to act as if you are the second brain of the user so you should write like their style. Generate a detailed outline with main sections and supporting points. Even with minimal input, create a logical structure that would help someone write an essay on the topic. Format the response as follows:\n\n1. Use bold section titles (like "Introduction", "Body", "Conclusion") without Roman numerals\n2. For first-level points, use numbers (1., 2., 3.)\n3. For second-level points, use letters (a., b., c.)\n4. For third-level points, use lowercase Roman numerals (i., ii., iii.)\n\nThe outline should serve as a prompt for users to write an essay on the topic.'},{role:"user",content:`Based on these braindump notes, create a detailed essay outline with the format described:\n\n${t}`}]})}),o=await n.json();if(!o.choices||!o.choices[0]||!o.choices[0].message)throw new Error("Invalid response from OpenAI API");return o.choices[0].message.content}function r(e){const t=document.getElementById("outline-container");if(!t)return;let n=e;n.includes("<h")||n.includes("<ul")||(n=function(e){const t=e.split("\n").filter((e=>e.trim()));let n="";const o=/^(I{1,3}|IV|V|VI{1,3}|IX|X)\.?\s+/,a=/^[A-Z]\.?\s+/,i=/^[•■▪★○◦*-]\s+/,r=/^\d+\.?\s+/,s=/^\*{1,2}([^*]+)\*{1,2}$/,l=/\*{1,2}([^*]+)\*{1,2}/g;t.some((e=>o.test(e.trim()))),t.some((e=>a.test(e.trim()))),t.some((e=>i.test(e.trim()))),t.some((e=>r.test(e.trim()))),n='<ul class="outline-root">';let c=0,d=["ul"];t.forEach((e=>{const t=e.trim();if(!t)return;const m=t.match(s);if(m){for(;d.length>1;)n+=`</${d.pop()}>`;return n+=`<li><span class="section-title">${m[1].trim()}</span></li>`,void(c=0)}let u=0,g=t,p=null,y=!1;if(o.test(t))u=0,p=t.match(o)[0],g=t.replace(o,""),y=!0;else if(a.test(t))u=1,p=t.match(a)[0],g=t.replace(a,"");else if(i.test(t)){const n=e.search(/\S|$/);u=Math.floor(n/2)+1,p=t.match(i)[0],g=t.replace(i,"")}else if(r.test(t)){const n=e.search(/\S|$/);u=Math.floor(n/2)+1,p=t.match(r)[0],g=t.replace(r,"")}else{const t=e.search(/\S|$/);u=Math.floor(t/2)}if(u>c)for(let e=c;e<u;e++)n+="<ul>",d.push("ul");else if(u<c)for(let e=c;e>u;e--)n+=`</${d.pop()}>`;g=g.replace(l,"<strong>$1</strong>"),y?n+=`<li><span class="section-title">${g}</span></li>`:p&&r.test(p)?n+=`<li class="numbered-entry"><span class="outline-marker">${p}</span>${g}</li>`:p&&a.test(p)?n+=`<li><span class="outline-marker">${p}</span>${g}</li>`:n+=`<li>${p?`<span class="outline-marker">${p}</span>`:""}${g}</li>`,c=u}));for(let e=0;e<d.length;e++)n+=`</${d[d.length-e-1]}>`;return n}(n)),t.innerHTML=n}})();
//# sourceMappingURL=sidebar.js.map
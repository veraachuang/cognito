(()=>{console.log("[Cognito] Sidebar script loaded");class e{constructor(){this.activeTab="upload",this.lastWritingUpdate=null,this.elements=this.initElements(),this.initEventListeners(),this.switchTab(this.activeTab),this.notifyParentReady()}initElements(){return{closeBtn:document.getElementById("close-sidebar"),tabButtons:document.querySelectorAll(".tab-button"),tabPanels:document.querySelectorAll(".tab-panel"),braindumpInput:document.getElementById("braindump-input"),uploadButton:document.getElementById("upload-button"),fileInput:document.getElementById("file-input"),uploadDropzone:document.getElementById("upload-dropzone"),uploadedFiles:document.getElementById("uploaded-files"),analyzeButton:document.getElementById("analyze-button"),outlineContainer:document.getElementById("outline-container"),regenerateOutline:document.getElementById("regenerate-outline"),applyOutline:document.getElementById("apply-outline"),promptsContainer:document.getElementById("prompts-container"),wordCount:document.getElementById("word-count"),readingTime:document.getElementById("reading-time"),gradeLevel:document.getElementById("grade-level"),writingStyle:document.getElementById("writing-style"),vocabularyLevel:document.getElementById("vocabulary-level"),sentenceStructure:document.getElementById("sentence-structure"),clarityScore:document.getElementById("clarity-score"),engagementScore:document.getElementById("engagement-score"),recommendationsContainer:document.getElementById("recommendations-container")}}initEventListeners(){window.addEventListener("message",this.handleWindowMessage.bind(this)),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",(()=>{window.parent.postMessage({action:"closeSidebar"},"*")})),this.elements.tabButtons&&this.elements.tabButtons.forEach((e=>{e.addEventListener("click",(()=>{this.switchTab(e.dataset.tab)}))})),this.elements.braindumpInput&&this.elements.braindumpInput.addEventListener("input",(e=>{this.analyzeText(e.target.value),this.updateLastWritingTime()})),this.initFileUploadListeners(),this.initOutlineButtonListeners()}initFileUploadListeners(){const{uploadButton:e,fileInput:t,uploadDropzone:n}=this.elements;e&&t&&(e.addEventListener("click",(()=>{t.click()})),t.addEventListener("change",(e=>{this.handleFiles(e.target.files)}))),n&&(n.addEventListener("dragover",(e=>{e.preventDefault(),n.classList.add("drag-over")})),n.addEventListener("dragleave",(()=>{n.classList.remove("drag-over")})),n.addEventListener("drop",(e=>{e.preventDefault(),n.classList.remove("drag-over"),this.handleFiles(e.dataTransfer.files)})))}initOutlineButtonListeners(){const{analyzeButton:e,regenerateOutline:t,applyOutline:n,outlineContainer:i}=this.elements;e&&e.addEventListener("click",(async()=>{const e=this.elements.braindumpInput?.value.trim();if(e)try{const t=await this.getCursorPosition(),n=await this.generateOutline(e,t);this.displayOutline(n.outline),this.switchTab("outline"),window.parent.postMessage({action:"applyOutline",data:{outline:n.outline,cursor_position:t}},"*")}catch(e){console.error("Error generating outline:",e),alert("Failed to generate outline. Please try again.")}})),t&&t.addEventListener("click",(()=>{e&&e.click()})),n&&i&&n.addEventListener("click",(()=>{const e=Array.from(i.querySelectorAll(".outline-section")).map((e=>({title:e.querySelector("h3")?.textContent.replace(/^\d+\.\s/,"")||"",points:Array.from(e.querySelectorAll("li")).map((e=>e.textContent))})));window.parent.postMessage({action:"applyOutline",data:{outline:e}},"*")}))}handleWindowMessage(e){const{action:t,data:n,features:i,tab:a}=e.data;"switchTab"===t&&a?this.switchTab(a):"liveTextUpdate"===t&&(this.updateAnalysisTab(n),i&&this.updateTextFeatures(i),this.updateLastWritingTime())}switchTab(e){console.log("Switching to tab:",e),this.activeTab=e,this.elements.tabButtons?.forEach((t=>{t.dataset.tab===e?t.classList.add("active"):t.classList.remove("active")})),this.elements.tabPanels?.forEach((t=>{t.id===e?(t.classList.add("active"),t.style.display="block"):(t.classList.remove("active"),t.style.display="none")})),"braindump"===e&&this.elements.braindumpInput&&this.analyzeText(this.elements.braindumpInput.value)}updateTextFeatures(e){const{wordCount:t,readingTime:n}=this.elements;t&&(t.textContent=e.wordCount),n&&(n.textContent=e.readingTime)}updateLastWritingTime(){this.lastWritingUpdate=Date.now(),localStorage.setItem("lastWritingUpdate",this.lastWritingUpdate)}handleFiles(e){const{uploadedFiles:t}=this.elements;t&&e&&e.length&&(Array.from(e).forEach((e=>{const n=document.createElement("div");n.className="file-item",n.innerHTML=`\n        <span class="file-icon"><i class="fas fa-file-alt"></i></span>\n        <span class="file-name">${e.name}</span>\n      `,t.appendChild(n)})),window.parent.postMessage({action:"uploadFiles",data:{files:Array.from(e)}},"*"))}async getCursorPosition(){return new Promise((e=>{window.parent.postMessage({action:"getCursorPosition"},"*");const t=n=>{"cursorPosition"===n.data.action&&(window.removeEventListener("message",t),e(n.data.position))};window.addEventListener("message",t)}))}async generateOutline(e,t){const n=await fetch("http://127.0.0.1:5000/api/generate-outline",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},mode:"cors",body:JSON.stringify({text:e,cursor_position:t})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}displayOutline(e){const{outlineContainer:t}=this.elements;if(!t)return;if(!e||!e.sections)return void(t.innerHTML='<p class="error">Failed to generate outline. Please try again.</p>');let n='<div class="outline-sections">';e.sections.forEach(((e,t)=>{n+=`\n        <div class="outline-section">\n          <h3>${t+1}. ${e.title}</h3>\n          <ul>\n            ${e.key_points.map((e=>`<li>${e}</li>`)).join("")}\n          </ul>\n          ${e.suggested_length?`<p class="suggested-length">Suggested length: ~${e.suggested_length} words</p>`:""}\n        </div>\n      `})),n+="</div>",t.innerHTML=n}analyzeText(e){if(!e)return;const t=this.parseText(e),n=this.calculateTextMetrics(t);this.updateAnalysisDisplay(n),this.isWriterStuck(e,t)&&this.generateWritingPrompts()}parseText(e){const t=e.trim(),n=t.split(/\s+/).filter(Boolean),i=t.split(/[.!?]+/).filter((e=>e.trim().length>0));return{text:t,words:n,sentences:i,syllables:this.countSyllables(t)}}calculateTextMetrics(e){const{words:t,sentences:n,syllables:i}=e,a=t.length,s=Math.ceil(a/200),o=a/Math.max(1,n.length),l=i/Math.max(1,a),r=Math.round(.39*o+11.8*l-15.59),d=t.reduce(((e,t)=>e+t.length),0)/Math.max(1,a),c=a/Math.max(1,n.length),u=this.determineWritingStyle(d,c),m=t.filter((e=>e.length>7)).length/Math.max(1,a),p=m>.2?"Advanced":m>.1?"Moderate":"Basic",g=c>20?"Complex":c>12?"Varied":"Simple",h=Math.max(50,Math.min(100,120-2*c)),y=["exciting","surprising","dramatic","incredible","unexpected","strange","intense"],v=t.filter((e=>y.includes(e.toLowerCase()))).length,w=Math.min(100,70+3*v);return{wordCount:a,readingTime:s,gradeLevel:r,writingStyle:u,vocabLevel:p,sentenceStructure:g,clarityScore:Math.round(h),engagementScore:w}}updateAnalysisDisplay(e){const{wordCount:t,readingTime:n,gradeLevel:i,writingStyle:a,vocabularyLevel:s,sentenceStructure:o,clarityScore:l,engagementScore:r,recommendationsContainer:d}=this.elements;t&&(t.textContent=e.wordCount),n&&(n.textContent=`${e.readingTime} min`),i&&(i.textContent=e.gradeLevel),a&&(a.textContent=e.writingStyle),s&&(s.textContent=e.vocabLevel),o&&(o.textContent=e.sentenceStructure),l&&(l.textContent=`${e.clarityScore}%`),r&&(r.textContent=`${e.engagementScore}%`),d&&(d.innerHTML="\n        <ul>\n          <li>Use more vivid and specific vocabulary.</li>\n          <li>Vary sentence structure for better rhythm.</li>\n          <li>Simplify long or complex sentences.</li>\n        </ul>\n      ")}countSyllables(e){const t=e.trim().toLowerCase().split(/\s+/);let n=0;return t.forEach((e=>{(e=e.replace(/[^a-z]/g,"")).length<=3?n+=1:n+=e.replace(/[^aeiouy]+/g," ").trim().split(/\s+/).length})),n}determineWritingStyle(e,t){return e>5&&t>20?"Academic":e<4&&t<15?"Conversational":"Balanced"}updateAnalysisTab(e){this.analyzeText(e)}isWriterStuck(e,t){const n=t.words.slice(-10);if(new Set(n).size<5)return!0;const i=localStorage.getItem("lastWritingUpdate");return!!(i&&Date.now()-i>3e4)}generateWritingPrompts(){const{promptsContainer:e,braindumpInput:t}=this.elements;e&&(e.innerHTML="",["What is the main point you want to convey?","How does this connect to your previous ideas?","Can you provide an example to illustrate this?","What would someone who disagrees with you say?","How does this relate to your overall topic?"].forEach((n=>{const i=document.createElement("div");i.className="prompt",i.textContent=n,t&&(i.onclick=()=>{t.value+="\n\n"+n,t.focus()}),e.appendChild(i)})))}notifyParentReady(){window.parent.postMessage({action:"sidebarReady"},"*")}}document.addEventListener("DOMContentLoaded",(()=>{new e}))})();
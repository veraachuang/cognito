(()=>{let e=null;function t(e){const t=e.trim().split(/\s+/).length,n=Math.ceil(t/200),o=function(e){const t=e.trim().split(/\s+/),n=e.split(/[.!?]+/).filter((e=>e.trim())),o=function(e){return e.trim().toLowerCase().split(/\s+/).reduce(((e,t)=>(t=t.replace(/[^a-z]/g,"")).length<=3?e+1:e+t.replace(/[^aeiouy]+/g," ").trim().split(/\s+/).length),0)}(e),r=t.length/Math.max(1,n.length),a=o/Math.max(1,t.length);return Math.round(.39*r+11.8*a-15.59)}(e),r=function(e){const t=e.trim().split(/\s+/),n=e.split(/[.!?]+/).filter((e=>e.trim())),o=t.reduce(((e,t)=>e+t.length),0)/t.length,r=t.length/Math.max(1,n.length);return o>5&&r>20?"Academic":o<4&&r<15?"Conversational":"Balanced"}(e);document.getElementById("word-count").textContent=t,document.getElementById("reading-time").textContent=`${n} min`,document.getElementById("grade-level").textContent=o,document.getElementById("writing-style").textContent=r,function(e){const t=e.trim().split(/\s+/).slice(-10),n=new Set(t),o=localStorage.getItem("lastWritingUpdate");return n.size<5||o&&Date.now()-o>3e4}(e)&&function(){const e=document.getElementById("prompts-container");e.innerHTML="",["What is the main point you want to convey?","How does this connect to your previous ideas?","Can you provide an example to illustrate this?","What would someone who disagrees with you say?","How does this relate to your overall topic?"].forEach((t=>{const n=document.createElement("div");n.className="prompt",n.textContent=t,n.onclick=()=>{const e=document.getElementById("braindump-input");e&&(e.value+=`\n\n${t}`,e.focus())},e.appendChild(n)}))}()}async function n(e){try{const t=await fetch("http://localhost:5003/api/generate-outline",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok){const e=await t.text();throw new Error(`Server error: ${t.status} - ${e}`)}const n=await t.json();if(n.outline)return n.outline;if(n.choices&&n.choices[0]&&n.choices[0].message)return n.choices[0].message.content;throw new Error("Invalid response from API server")}catch(e){throw console.error("[Cognito] Outline generation error:",e),e}}function o(e){const t=document.getElementById("outline-container");if(!t)return;let n=e;n.includes("<h")||n.includes("<ul")||(n=function(e){const t=e.split("\n").filter((e=>e.trim()));let n="";const o=t.some((e=>/^\d+\./.test(e.trim()))),r=t.some((e=>/^[•\-\*]/.test(e.trim()))),a=t.some((e=>/^\s+/.test(e)));if(o||r||a){let e=0,a=!1;t.forEach((t=>{const i=t.trim(),s=t.search(/\S|$/),l=Math.floor(s/2),c=/^#/.test(i)||!o&&!r&&0===l,d=/^(\d+\.|\*|•|\-)/.test(i);if(c){a&&(n+="</ul>",a=!1);const e=Math.min(l+3,4),t=i.replace(/^#+\s*/,"");n+=`<h${e}>${t}</h${e}>`}else{l>e?(n+="<ul>",a=!0):l<e&&a&&(n+="</ul>");const t=d?i.replace(/^(\d+\.|\*|•|\-)\s*/,""):i;n+=`<li>${t}</li>`,e=l}})),a&&(n+="</ul>")}else{let e=null;n+="<ul>",t.forEach((t=>{const o=t.trim();o.toUpperCase()===o&&o.length>3?(n+=e?"</ul>":"",n+=`<h3>${o}</h3><ul>`,e=o):n+=`<li>${o}</li>`})),n+="</ul>"}return n}(n)),t.innerHTML=n}console.log("[Cognito] Sidebar script loaded"),window.parent.postMessage({action:"sidebarReady"},"*"),window.addEventListener("message",(t=>{"docId"===t.data?.action&&(e=t.data.value,console.log("[Cognito] Received Doc ID →",e))})),document.addEventListener("DOMContentLoaded",(()=>{const r=document.getElementById("close-sidebar"),a=document.querySelectorAll(".tab-button"),i=document.querySelectorAll(".tab-panel"),s=document.getElementById("braindump-input"),l=document.getElementById("analyzing-spinner"),c=document.getElementById("file-input"),d=document.getElementById("upload-button"),m=document.getElementById("upload-dropzone"),u=document.getElementById("uploaded-files"),g=document.getElementById("analyze-button"),p=document.getElementById("outline-container"),y=document.getElementById("regenerate-outline"),f=document.getElementById("apply-outline");function h(e){a.forEach((t=>t.classList.toggle("active",t.dataset.tab===e))),i.forEach((t=>t.classList.toggle("active",t.id===e))),"braindump"===e&&t(s.value)}function E(e){if(u)for(const n of e){const e=document.createElement("div");e.className="file-item";let o="fa-file";const r=n.name.split(".").pop().toLowerCase();"pdf"===r?o="fa-file-pdf":"doc"===r||"docx"===r?o="fa-file-word":"txt"===r&&(o="fa-file-lines"),e.innerHTML=`\n          <i class="fas ${o}" style="margin-right: 10px; color: var(--primary-text);"></i>\n          <span>${n.name}</span>\n          <span style="margin-left: auto; font-size: 12px; color: #666;">${t=n.size,t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}</span>\n          <button class="icon-button remove-file" style="margin-left: 8px;">\n            <i class="fas fa-times"></i>\n          </button>\n        `;const a=e.querySelector(".remove-file");a&&a.addEventListener("click",(()=>{e.remove()})),u.appendChild(e)}var t}h("upload"),r.addEventListener("click",(()=>{window.parent.postMessage({action:"closeSidebar"},"*")})),a.forEach((e=>{e.addEventListener("click",(()=>h(e.dataset.tab)))})),g&&g.addEventListener("click",(async()=>{const e=s.value.trim();if(e){g.disabled=!0,g.innerHTML='<i class="fas fa-spinner fa-spin"></i> Generating...';try{o(await n(e)),h("outline")}catch(e){console.error("Error generating outline:",e),alert("Failed to generate outline. Please try again.")}finally{g.disabled=!1,g.innerHTML="Analyze & Create Outline"}}else alert("Please enter some text in the brain dump area first.")})),y&&y.addEventListener("click",(async()=>{const e=s.value.trim();if(e){y.disabled=!0,y.innerHTML='<i class="fas fa-spinner fa-spin"></i> Regenerating...';try{o(await n(e))}catch(e){console.error("Error regenerating outline:",e)}finally{y.disabled=!1,y.innerHTML='<i class="fas fa-redo"></i> Regenerate'}}})),f&&f.addEventListener("click",(()=>{window.parent.postMessage({action:"applyOutline",outline:p.innerHTML},"*")})),d&&c&&d.addEventListener("click",(()=>{c.click()})),c&&c.addEventListener("change",(e=>{E(e.target.files)})),m&&(m.addEventListener("dragover",(e=>{e.preventDefault(),m.classList.add("drag-over")})),m.addEventListener("dragleave",(()=>{m.classList.remove("drag-over")})),m.addEventListener("drop",(e=>{e.preventDefault(),m.classList.remove("drag-over"),e.dataTransfer.files.length>0&&E(e.dataTransfer.files)}))),s.addEventListener("input",(e=>{t(e.target.value),localStorage.setItem("lastWritingUpdate",Date.now())}));const v=document.getElementById("analyze-doc-button"),w=document.getElementById("analysis-status"),I=document.getElementById("recommendations-container");v&&v.addEventListener("click",(async()=>{w.textContent="Fetching document text...",I.innerHTML="",l&&(l.style.display="block");try{const t=await async function(){if(!e)throw new Error("No Google-Docs ID – the iframe never received it.");return new Promise(((t,n)=>{chrome.runtime.sendMessage({action:"getDocText",docId:e},(e=>chrome.runtime.lastError?n(chrome.runtime.lastError.message):e?e.error?n(e.error):e.text?void t(e.text):n("Background returned no text."):n("No response from background.")))}))}();w.textContent="Analyzing with OpenAI...",await async function(e){try{const t=await fetch("http://localhost:5003/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok){const e=await t.text();throw new Error(`Server error: ${t.status} - ${e}`)}const n=await t.json();if(n.vocabulary_level&&n.sentence_structure){document.getElementById("vocabulary-level").textContent=n.vocabulary_level||"-",document.getElementById("sentence-structure").textContent=n.sentence_structure||"-";const e=e=>"number"==typeof e&&e<=1?Math.round(100*e)+"%":e;document.getElementById("clarity-score").textContent=e(n.clarity_score),document.getElementById("engagement-score").textContent=e(n.engagement_score);let t=[];Array.isArray(n.recommendations)?t=n.recommendations:"string"==typeof n.recommendations&&(t=[n.recommendations]),t.length?document.getElementById("recommendations-container").innerHTML=`<ul>${t.map((e=>`<li>${e}</li>`)).join("")}</ul>`:document.getElementById("recommendations-container").innerHTML='<p class="suggested-length">No recommendations returned.</p>'}else{if(!(n.choices&&n.choices[0]&&n.choices[0].message))throw new Error("Unexpected response format from server");{const e=n.choices[0].message.content;let t;try{t="string"==typeof e?JSON.parse(e):e}catch(t){throw console.error("[Cognito] Error parsing response:",t),new Error(e)}document.getElementById("vocabulary-level").textContent=t.vocabulary_level||"-",document.getElementById("sentence-structure").textContent=t.sentence_structure||"-";const o=e=>"number"==typeof e&&e<=1?Math.round(100*e)+"%":e;document.getElementById("clarity-score").textContent=o(t.clarity_score),document.getElementById("engagement-score").textContent=o(t.engagement_score);let r=[];Array.isArray(t.recommendations)?r=t.recommendations:"string"==typeof t.recommendations&&(r=[t.recommendations]),r.length?document.getElementById("recommendations-container").innerHTML=`<ul>${r.map((e=>`<li>${e}</li>`)).join("")}</ul>`:document.getElementById("recommendations-container").innerHTML='<p class="suggested-length">No recommendations returned.</p>'}}}catch(e){throw console.error("[Cognito] Analysis error:",e),e}}(t),w.textContent="Analysis complete."}catch(e){w.textContent="Failed to analyze.",I.innerHTML=`<p class="error">Error: ${e}</p>`}finally{l&&(l.style.display="none")}}))}))})();
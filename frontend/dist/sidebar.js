(()=>{console.log("[Cognito] Sidebar script loaded");class e{constructor(){this.activeTab="upload",this.lastWritingUpdate=null,this.elements=this.initElements(),this.initEventListeners(),this.switchTab(this.activeTab),this.notifyParentReady()}initElements(){return{closeBtn:document.getElementById("close-sidebar"),tabButtons:document.querySelectorAll(".tab-button"),tabPanels:document.querySelectorAll(".tab-panel"),braindumpInput:document.getElementById("braindump-input"),uploadButton:document.getElementById("upload-button"),fileInput:document.getElementById("file-input"),uploadDropzone:document.getElementById("upload-dropzone"),uploadedFiles:document.getElementById("uploaded-files"),analyzeButton:document.getElementById("analyze-button"),outlineContainer:document.getElementById("outline-container"),regenerateOutline:document.getElementById("regenerate-outline"),applyOutline:document.getElementById("apply-outline"),promptsContainer:document.getElementById("prompts-container"),wordCount:document.getElementById("word-count"),readingTime:document.getElementById("reading-time"),gradeLevel:document.getElementById("grade-level"),writingStyle:document.getElementById("writing-style"),vocabularyLevel:document.getElementById("vocabulary-level"),sentenceStructure:document.getElementById("sentence-structure"),clarityScore:document.getElementById("clarity-score"),engagementScore:document.getElementById("engagement-score"),recommendationsContainer:document.getElementById("recommendations-container")}}initEventListeners(){window.addEventListener("message",this.handleWindowMessage.bind(this)),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",(()=>{window.parent.postMessage({action:"closeSidebar"},"*")})),this.elements.tabButtons&&this.elements.tabButtons.forEach((e=>{e.addEventListener("click",(()=>{this.switchTab(e.dataset.tab)}))})),this.elements.braindumpInput&&this.elements.braindumpInput.addEventListener("input",(e=>{this.analyzeText(e.target.value),this.updateLastWritingTime()})),this.initFileUploadListeners(),this.initOutlineButtonListeners()}initFileUploadListeners(){const{uploadButton:e,fileInput:t,uploadDropzone:n}=this.elements;e&&t&&(e.addEventListener("click",(()=>{t.click()})),t.addEventListener("change",(e=>{this.handleFiles(e.target.files)}))),n&&(n.addEventListener("dragover",(e=>{e.preventDefault(),n.classList.add("drag-over")})),n.addEventListener("dragleave",(()=>{n.classList.remove("drag-over")})),n.addEventListener("drop",(e=>{e.preventDefault(),n.classList.remove("drag-over"),this.handleFiles(e.dataTransfer.files)})))}initOutlineButtonListeners(){const{analyzeButton:e,regenerateOutline:t,applyOutline:n,outlineContainer:i}=this.elements;e&&e.addEventListener("click",(async()=>{const e=this.elements.braindumpInput?.value.trim();if(e)try{const t=await this.getCursorPosition(),n=await this.generateOutline(e,t);this.displayOutline(n.outline),this.switchTab("outline"),window.parent.postMessage({action:"applyOutline",data:{outline:n.outline,cursor_position:t}},"*")}catch(e){console.error("Error generating outline:",e),alert("Failed to generate outline. Please try again.")}})),t&&t.addEventListener("click",(()=>{e&&e.click()})),n&&i&&n.addEventListener("click",(()=>{const e=Array.from(i.querySelectorAll(".outline-section")).map((e=>({title:e.querySelector("h3")?.textContent.replace(/^\d+\.\s/,"")||"",points:Array.from(e.querySelectorAll("li")).map((e=>e.textContent))})));window.parent.postMessage({action:"applyOutline",data:{outline:e}},"*")}))}handleWindowMessage(e){const{action:t,data:n,features:i,tab:a}=e.data;"switchTab"===t&&a?this.switchTab(a):"liveTextUpdate"===t&&(this.updateAnalysisTab(n),i&&this.updateTextFeatures(i),this.updateLastWritingTime())}switchTab(e){console.log("Switching to tab:",e),this.activeTab=e,this.elements.tabButtons?.forEach((t=>{t.dataset.tab===e?t.classList.add("active"):t.classList.remove("active")})),this.elements.tabPanels?.forEach((t=>{t.id===e?(t.classList.add("active"),t.style.display="block"):(t.classList.remove("active"),t.style.display="none")})),"braindump"===e&&this.elements.braindumpInput&&this.analyzeText(this.elements.braindumpInput.value)}updateTextFeatures(e){const{wordCount:t,readingTime:n}=this.elements;t&&(t.textContent=e.wordCount),n&&(n.textContent=e.readingTime)}updateLastWritingTime(){this.lastWritingUpdate=Date.now(),localStorage.setItem("lastWritingUpdate",this.lastWritingUpdate)}handleFiles(e){const{uploadedFiles:t}=this.elements;t&&e&&e.length&&(Array.from(e).forEach((e=>{const n=document.createElement("div");n.className="file-item",n.innerHTML=`\n        <span class="file-icon"><i class="fas fa-file-alt"></i></span>\n        <span class="file-name">${e.name}</span>\n      `,t.appendChild(n)})),window.parent.postMessage({action:"uploadFiles",data:{files:Array.from(e)}},"*"))}async getCursorPosition(){return new Promise((e=>{window.parent.postMessage({action:"getCursorPosition"},"*");const t=n=>{"cursorPosition"===n.data.action&&(window.removeEventListener("message",t),e(n.data.position))};window.addEventListener("message",t)}))}async generateOutline(e,t){const n=await fetch("http://127.0.0.1:5000/api/generate-outline",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},mode:"cors",body:JSON.stringify({text:e,cursor_position:t})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}displayOutline(e){const{outlineContainer:t}=this.elements;if(!t)return;if(!e||!e.sections)return void(t.innerHTML='<p class="error">Failed to generate outline. Please try again.</p>');let n='<div class="outline-sections">';e.sections.forEach(((e,t)=>{n+=`\n        <div class="outline-section">\n          <h3>${t+1}. ${e.title}</h3>\n          <ul>\n            ${e.key_points.map((e=>`<li>${e}</li>`)).join("")}\n          </ul>\n          ${e.suggested_length?`<p class="suggested-length">Suggested length: ~${e.suggested_length} words</p>`:""}\n        </div>\n      `})),n+="</div>",t.innerHTML=n}analyzeText(e){if(!e)return;const t=this.parseText(e),n=this.calculateTextMetrics(t);this.updateAnalysisDisplay(n),this.isWriterStuck(e,t)&&this.generateWritingPrompts()}parseText(e){if(!e)return{sentences:[],paragraphs:[]};const t=e.split(/\r?\n/).filter((e=>e.trim().length>0)),n=/[^.!?]+[.!?]+|\s+[A-Z][^.!?]*$/g;let i=[];return t.forEach((e=>{const t=e.match(n)||[];i=i.concat(t.map((e=>e.trim())).filter((e=>e.length>0)))})),{sentences:i,paragraphs:t,wordCount:e.split(/\s+/).filter((e=>e.trim().length>0)).length,characterCount:e.replace(/\s+/g,"").length}}calculateTextMetrics(e){const{sentences:t,paragraphs:n,wordCount:i,characterCount:a}=e,s=Math.ceil(i/200),r=t.length?t.reduce(((e,t)=>e+t.split(/\s+/).filter((e=>e.trim().length>0)).length),0)/t.length:0,l=(n.length&&(n.reduce(((e,t)=>e+t.split(/\s+/).filter((e=>e.trim().length>0)).length),0),n.length),e.sentences.join(" ").split(/\s+/).filter((e=>e.trim().length>0))),o=l.length?l.reduce(((e,t)=>e+t.replace(/[^a-zA-Z]/g,"").length),0)/l.length:0,c=this.calculateFleschKincaid(t,i),d=this.determineWritingStyle(r,o),u=this.calculateVocabularyLevel(l),h=this.calculateSentenceStructure(t),g=this.calculateClarityScore(r,o,c),m=this.calculateEngagementScore(t,n,l);return{wordCount:i,characterCount:a,readingTime:`${s} min`,gradeLevel:c.toFixed(1),writingStyle:d,vocabularyLevel:u.toFixed(1),sentenceStructure:h.toFixed(1),clarityScore:g.toFixed(1),engagementScore:m.toFixed(1)}}updateAnalysisDisplay(e){const{wordCount:t,readingTime:n,gradeLevel:i,writingStyle:a,vocabularyLevel:s,sentenceStructure:r,clarityScore:l,engagementScore:o,recommendationsContainer:c}=this.elements;t&&(t.textContent=e.wordCount),n&&(n.textContent=e.readingTime),i&&(i.textContent=e.gradeLevel),a&&(a.textContent=e.writingStyle),s&&(s.textContent=e.vocabularyLevel),r&&(r.textContent=e.sentenceStructure),l&&(l.textContent=e.clarityScore),o&&(o.textContent=e.engagementScore),c&&(c.innerHTML="\n        <ul>\n          <li>Use more vivid and specific vocabulary.</li>\n          <li>Vary sentence structure for better rhythm.</li>\n          <li>Simplify long or complex sentences.</li>\n        </ul>\n      ")}countSyllables(e){const t=e.trim().toLowerCase().split(/\s+/);let n=0;return t.forEach((e=>{(e=e.replace(/[^a-z]/g,"")).length<=3?n+=1:n+=e.replace(/[^aeiouy]+/g," ").trim().split(/\s+/).length})),n}determineWritingStyle(e,t){return e<10?t<4.5?"Concise":"Technical":e<18?t<4.5?"Conversational":"Balanced":t<4.5?"Narrative":"Academic"}updateAnalysisTab(e){if(e&&""!==e.trim())try{console.log("[Cognito] Analyzing text:",e.slice(0,100)+"...");const t=this.parseText(e),n=this.calculateTextMetrics(t);this.updateAnalysisDisplay(n),this.isWriterStuck(e,t)&&this.showWritingPrompts()}catch(e){console.error("[Cognito] Error analyzing text:",e),this.showAnalysisError()}else console.warn("[Cognito] Empty text received, skipping analysis")}isWriterStuck(e,t){const n=t.words.slice(-10);if(new Set(n).size<5)return!0;const i=localStorage.getItem("lastWritingUpdate");return!!(i&&Date.now()-i>3e4)}generateWritingPrompts(){const{promptsContainer:e,braindumpInput:t}=this.elements;e&&(e.innerHTML="",["What is the main point you want to convey?","How does this connect to your previous ideas?","Can you provide an example to illustrate this?","What would someone who disagrees with you say?","How does this relate to your overall topic?"].forEach((n=>{const i=document.createElement("div");i.className="prompt",i.textContent=n,t&&(i.onclick=()=>{t.value+="\n\n"+n,t.focus()}),e.appendChild(i)})))}showAnalysisError(){["writing-style","vocabulary-level","sentence-structure","clarity-score","engagement-score"].forEach((e=>{const t=document.getElementById(e);t&&(t.textContent="Analysis unavailable")}));const e=document.getElementById("recommendations-container");e&&(e.innerHTML="<p>Unable to analyze the document. Please try again or ensure there is enough text in the document for meaningful analysis.</p>")}calculateFleschKincaid(e,t){return e.length&&t?t/e.length*.39+this.estimateSyllableCount(e.join(" "))/t*11.8-15.59:0}estimateSyllableCount(e){if(!e)return 0;const t=e.replace(/[^a-zA-Z\s]/g,"").toLowerCase().split(/\s+/);let n=0;const i=["a","e","i","o","u","y"];return t.forEach((e=>{let t=0,a=!1;for(let n=0;n<e.length;n++){const s=i.includes(e[n]);s&&!a&&t++,a=s}e.length>3&&(e.endsWith("e")&&!e.endsWith("le")&&t--,e.endsWith("y")&&!i.includes(e[e.length-2])&&t++,(e.endsWith("es")||e.endsWith("ed"))&&t--),n+=Math.max(1,t)})),n}calculateVocabularyLevel(e){return e.length?new Set(e.map((e=>e.toLowerCase()))).size/e.length*5+e.reduce(((e,t)=>e+t.length),0)/e.length/10*5:0}calculateSentenceStructure(e){if(!e.length)return 0;const t=e.map((e=>e.split(/\s+/).length)),n=t.reduce(((e,t)=>e+t),0)/t.length,i=t.reduce(((e,t)=>e+Math.pow(t-n,2)),0)/t.length,a=Math.sqrt(i),s=e.map((e=>e.trim().split(/\s+/)[0]?.toLowerCase())).filter(Boolean);return a/5*5+new Set(s).size/Math.max(1,s.length)*5}calculateClarityScore(e,t,n){return 10*(.4*(1-Math.min(1,Math.abs(e-15)/10))+.3*(1-Math.min(1,Math.abs(t-4.5)/2))+.3*(1-Math.min(1,Math.abs(n-9)/5)))}calculateEngagementScore(e,t,n){if(!e.length||!t.length||!n.length)return 0;const i=e.filter((e=>e.includes("?")||e.includes("!"))).length/e.length,a=t.map((e=>e.split(/\s+/).length)),s=a.reduce(((e,t)=>e+t),0)/a.length,r=a.reduce(((e,t)=>e+Math.pow(t-s,2)),0)/a.length,l=Math.sqrt(r),o=Math.min(1,l/5),c=n.join(" ").toLowerCase(),d=["however","therefore","furthermore","moreover","meanwhile","nevertheless","although","despite","accordingly","consequently","thus","indeed","instead","meanwhile","nonetheless","similarly","whereas","conversely"].reduce(((e,t)=>{const n=new RegExp(`\\b${t}\\b`,"g");return e+(c.match(n)||[]).length}),0);return 1*(3*i+3*o+4*Math.min(1,d/(n.length/50)))}notifyParentReady(){window.parent.postMessage({action:"sidebarReady"},"*")}}document.addEventListener("DOMContentLoaded",(()=>{new e}))})();